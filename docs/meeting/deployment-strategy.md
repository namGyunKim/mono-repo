# 배포 전략 요약

> 이 문서는 **비개발자(기획, 디자인 등)에게 프로젝트의 배포·CI 구조를 설명**하기 위한 미팅용 요약 문서다.
> 개발자용 상세 가이드: [BLUE_GREEN.md](../backend/deployment/BLUE_GREEN.md), [CI_STRATEGY.md](../CI_STRATEGY.md)

---

## 한줄 요약

**AWS 올인원** — ALB + EC2 2대 Blue/Green 무중단 배포, ACM SSL, WAF 보안, S3 + CloudFront 이미지 서빙.
코드 변경은 **자동 품질 검사(CI)를 통과해야만** 반영된다.

---

## 전체 아키텍처

```
                    [클라이언트]
                        │
              ┌─────────▼──────────┐
              │     Route 53       │
              │   (DNS 라우팅)      │
              └────┬──────────┬────┘
                   │          │
         ┌─────────▼───┐  ┌──▼──────────────┐
         │     ALB     │  │  CloudFront      │
         │  + ACM SSL  │  │  (이미지 CDN)     │
         │  + WAF      │  │                  │
         └──┬───────┬──┘  └───────┬──────────┘
            │       │             │
     ┌──────▼──┐ ┌──▼──────┐  ┌──▼──────────┐
     │  EC2-1  │ │  EC2-2  │  │  S3 (비공개) │
     │ user-api│ │admin-api│  │  이미지 저장  │
     │ B/G     │ │ B/G     │  └─────────────┘
     └────┬────┘ └────┬────┘
          │           │
       ┌──▼───────────▼──┐
       │   RDS / EC2 DB   │
       │   PostgreSQL     │
       └─────────────────┘
```

---

## AWS 서비스 역할

| 서비스            | 역할                       | 비고                              |
|----------------|--------------------------|---------------------------------|
| **ALB**        | 로드밸런서, HTTPS 종료, EC2 라우팅 | 리스너: 443(HTTPS) → 타겟그룹(80)      |
| **ACM**        | SSL/TLS 인증서              | ALB에 연결, 자동 갱신, 무료              |
| **WAF**        | 웹 방화벽                    | ALB에 연결, SQL Injection/XSS 등 차단 |
| **EC2**        | 앱 서버 (t3a.large x 2)     | 1서버 1프로젝트, 각각 Blue/Green 배포     |
| **S3**         | 이미지 저장소                  | 비공개 버킷, 직접 접근 차단                |
| **CloudFront** | 이미지 CDN                  | OAC로 S3 비공개 접근, 캐싱 + 글로벌 배포     |
| **Route 53**   | DNS                      | 도메인 → ALB, 이미지 도메인 → CloudFront |

---

## 네트워크 흐름

### API 요청

```
클라이언트 → Route 53 → ALB (WAF 검사 → ACM SSL 종료) → EC2 Nginx(:80) → Docker 컨테이너
```

- ALB가 HTTPS를 처리하므로 EC2의 Nginx는 **HTTP(:80)만** 수신
- WAF가 ALB 앞단에서 악성 요청을 필터링

### 이미지 요청

```
클라이언트 → Route 53 → CloudFront (캐시) → S3 (비공개, OAC 인증)
```

- S3 버킷은 퍼블릭 접근 차단, CloudFront OAC(Origin Access Control)를 통해서만 접근
- CloudFront가 엣지 캐싱으로 S3 직접 요청을 최소화

---

## 배포 방식

### 자동 배포

배포 전용 브랜치에 push하면 해당 프로젝트만 자동 배포된다.

**현재 (테스트 서버만):**

| 브랜치                | 배포 대상     | 환경     |
|--------------------|-----------|--------|
| `deploy/user-api`  | user-api  | 테스트 서버 |
| `deploy/admin-api` | admin-api | 테스트 서버 |

**main 도입 후 (테스트 + 실서버):**

| 브랜치                | 배포 대상     | 환경     |
|--------------------|-----------|--------|
| `stage/user-api`   | user-api  | 테스트 서버 |
| `stage/admin-api`  | admin-api | 테스트 서버 |
| `deploy/user-api`  | user-api  | 실서버    |
| `deploy/admin-api` | admin-api | 실서버    |

```
git push origin stage/user-api    → 테스트 서버 배포
git push origin deploy/user-api   → 실서버 배포
  → GitHub Actions 자동 실행
    → JAR 빌드 → Docker 이미지 → GHCR push → SSH 배포
```

> 두 워크플로우 모두 같은 `backend-cd.yml`을 호출한다.
> GitHub Secret에 등록된 서버 IP만 다르게 지정하여 대상 서버를 결정한다.

### 수동 배포 / 롤백

```bash
# 서버에서 직접 배포
/opt/deploy/deploy.sh user-api latest

# 롤백 (이전 이미지 태그로 재배포, 재빌드 불필요)
/opt/deploy/deploy.sh user-api <이전-태그>
```

---

## CI (자동 품질 검사)

> 상세 설정: [docs/CI_STRATEGY.md](../CI_STRATEGY.md)

### CI란?

코드를 합치기(머지) 전에 **자동으로 빌드·테스트를 실행**해서, 문제가 있는 코드가 들어가는 것을 막는 장치다.
개발자가 PR(Pull Request)을 생성하면 GitHub가 알아서 검사를 돌리고, 통과해야만 머지 버튼이 활성화된다.

### 언제 실행되나?

- **PR을 생성하거나 업데이트할 때만** 실행된다
- 머지 후에는 실행하지 않는다 (PR 단계에서 이미 검증 완료)

> push 트리거를 제거한 이유: PR CI가 항상 최신 코드 기반으로 실행되도록 설정되어 있어서,
> 머지 후 다시 돌리는 건 같은 검사를 두 번 하는 것과 같다. 불필요한 비용을 줄이기 위해 제거했다.

### 검사 항목 (3단계)

```
PR 생성 → 자동 실행:

┌──────────────────┐  ┌──────────────────┐
│  1. 백엔드 검사    │  │  2. 프론트엔드 검사 │
│  (빌드 성공 여부)   │  │  (린트+테스트+빌드)  │
└────────┬─────────┘  └────────┬─────────┘
         └──────┬──────────────┘
         ┌──────▼──────┐
         │ 3. E2E 검사  │
         │ (실제 브라우저   │
         │  동작 테스트)   │
         └─────────────┘
         → 3개 모두 통과해야 머지 가능
```

| 단계            | 하는 일                                      | 소요 시간 |
|---------------|-------------------------------------------|-------|
| **백엔드 검사**   | Java 코드 컴파일 + 빌드가 깨지지 않는지 확인              | ~50초  |
| **프론트엔드 검사** | 코드 스타일 검사(린트) + 단위 테스트 + 빌드 확인            | ~28초  |
| **E2E 검사**    | 실제 서버를 띄우고 브라우저로 페이지 접속·API 호출 등 통합 테스트 수행 | ~2분   |

- 백엔드와 프론트엔드 검사는 **동시에** 실행된다 (시간 절약)
- E2E 검사는 둘 다 통과한 뒤에 실행된다 (서버를 띄워야 하므로)

### E2E 검사란?

E2E(End-to-End)는 **사용자가 실제로 서비스를 이용하는 과정을 그대로 재현하는 테스트**다.
백엔드·프론트엔드 검사가 "각 부품이 깨지지 않았는가"를 확인하는 거라면,
E2E는 "부품을 조립했을 때 전체가 제대로 동작하는가"를 확인하는 최종 검증이다.

**동작 방식:**

1. CI 서버에서 백엔드(Java)와 프론트엔드(Next.js)를 **실제로 기동**한다
2. 가상 브라우저(Chromium)가 자동으로 **페이지에 접속**한다
3. 미리 작성된 시나리오대로 **페이지 로딩, API 호출** 등을 수행한다
4. 예상대로 응답이 오는지 **자동으로 판정**한다

**현재 검증하는 항목:**

| 테스트            | 확인 내용                          |
|-----------------|--------------------------------|
| 헬스체크            | 백엔드 서버가 정상 응답하는지 (`/api/health`) |
| 홈페이지 렌더링        | 프론트엔드 페이지가 브라우저에 정상 표시되는지      |
| API 라우트         | Next.js API가 정상 응답하는지           |

**왜 필요한가?**

- 백엔드 빌드가 성공해도, 프론트엔드와 연결했을 때 에러가 날 수 있다
- 개별 테스트를 통과해도, 실제 서버 환경에서는 설정 누락 등으로 실패할 수 있다
- E2E가 이런 **연결 지점의 문제**를 머지 전에 잡아준다

### 머지 조건

PR을 develop에 머지하려면 아래 조건을 **모두** 충족해야 한다:

1. 백엔드·프론트엔드·E2E **3개 검사 모두 통과**
2. **최신 develop 기반**으로 검사 통과 (다른 PR이 먼저 머지되면 업데이트 후 재검사)
3. **Squash merge** 방식으로만 머지 가능 (커밋 이력을 1개로 합침)

---

## Blue/Green 전환 흐름

각 EC2 내부에서 Docker 컨테이너 단위로 Blue/Green 전환한다.

```
 현재 상태                    배포 중                        완료
 ─────────                  ──────                       ────
 Nginx → Blue(8081) ✅       Nginx → Blue(8081) ✅         Nginx → Green(8082) ✅
         Green ❌                    Green(8082) 기동 중           Blue 종료
```

| 단계  | 동작                         | 실패 시         |
|-----|----------------------------|--------------|
| 1   | 새 이미지 pull                 | 중단, 기존 유지    |
| 2   | 그린(8082) 컨테이너 기동           | 중단, 기존 유지    |
| 3   | 그린 health check            | 그린 제거, 블루 유지 |
| 4   | Nginx upstream 전환 + reload | 그린 제거, 블루 유지 |
| 5   | 블루 graceful shutdown (30초) | —            |
| 6   | 활성 컬러 기록                   | —            |

> 어느 단계에서 실패해도 기존 컨테이너가 트래픽을 처리하므로 **서비스 중단 없음**.

---

## 보안 구성

| 계층      | 방어        | 설명                                             |
|---------|-----------|------------------------------------------------|
| DNS     | Route 53  | AWS 관리형 DNS, DDoS 기본 방어                        |
| L7 방화벽  | WAF → ALB | SQL Injection, XSS, Bot 차단 (AWS Managed Rules) |
| SSL/TLS | ACM → ALB | HTTPS 종료, 자동 갱신, EC2에는 HTTP만 전달                |
| 네트워크    | 보안그룹      | EC2: ALB에서만 80 허용, S3: CloudFront OAC만 허용      |
| 이미지 저장  | S3 비공개    | 퍼블릭 접근 차단, CloudFront OAC 경유만 허용               |

---

## 이미지 서빙 (S3 + CloudFront)

| 항목                | 설정                                                 |
|-------------------|----------------------------------------------------|
| S3 버킷             | 비공개 (Block Public Access 전체 활성화)                   |
| CloudFront Origin | S3, OAC(Origin Access Control) 인증                  |
| 캐시 정책             | 이미지: 장기 캐시 (Cache-Control: max-age)                |
| 도메인               | `images.example.com` → CloudFront (Route 53 CNAME) |

```
앱 서버 (업로드)                     클라이언트 (조회)
     │                                    │
     ▼                                    ▼
  S3 (비공개)  ←── OAC 인증 ──  CloudFront (캐시)
```

> 앱에서 S3에 직접 업로드, 클라이언트는 CloudFront URL로 조회.
> S3 직접 URL은 접근 불가.

---

## 핵심 원칙

| 원칙        | 설명                                    |
|-----------|---------------------------------------|
| AWS 올인원   | SSL, WAF, CDN, 스토리지 모두 AWS 서비스로 통일    |
| 빌드/배포 분리  | CI에서 빌드, 서버에서는 pull + 기동만             |
| 불변 아티팩트   | Docker 이미지 = 배포 단위, 서버에 소스코드 없음       |
| 1서버 1프로젝트 | EC2마다 하나의 프로젝트만 운영                    |
| 비공개 원칙    | S3 비공개 + CloudFront OAC, EC2 직접 접근 차단 |

---

## 로깅 전략

| 항목    | 내용                                       |
|-------|------------------------------------------|
| 로그 위치 | `/app/logs/app.log` (호스트에 볼륨 마운트)        |
| 롤링    | 일별 자동 롤링, 최근 30일 보관, 파일당 100MB           |
| 백업    | cron이 매일 새벽 2시에 압축 → `/app/backup/`으로 이동 |
| 백업 보관 | 90일 초과 시 자동 삭제                           |

---

## 새 프로젝트 추가 시

1. `deploy-<프로젝트명>.yml` + `stage-<프로젝트명>.yml` 워크플로우 파일 생성 (기존 파일 복사, 프로젝트명만 변경)
2. EC2 신규 생성 + 서버 세팅 9단계 실행
3. ALB 타겟그룹에 새 EC2 등록
4. 배포 브랜치 생성: `git push origin develop:deploy/<프로젝트명>`
5. GitHub Secrets에 서버 IP 등록 (`<PROJECT>_SERVER_HOST`, `STAGE_<PROJECT>_SERVER_HOST`)
6. 공통 워크플로우(`backend-cd.yml`)와 배포 스크립트(`deploy.sh`)는 수정 불필요
