# 모든 백엔드 프로젝트가 호출하는 공통 재사용 워크플로우 (Reusable Workflow).
# 이 파일 자체는 단독으로 실행되지 않는다.
# 각 프로젝트 워크플로우(deploy-user-api.yml 등)가 workflow_call로 이 파일을 호출하며,
# project와 gradle-module 파라미터만 바꿔서 빌드/배포 로직을 공유한다.
#
# 새 프로젝트 추가 시: 이 파일은 수정할 필요 없다.
#   deploy-user-api.yml을 복사하여 project와 gradle-module, 브랜치명만 바꾼
#   deploy-<프로젝트명>.yml을 만들면 된다.
# 이 파일을 수정하는 경우: 빌드/배포 공통 로직 자체가 변경될 때만.
#   (예: Java 버전 변경, Docker 빌드 옵션 추가 등)
#
# 원본: docs/backend/deployment/deploy-backend.yml
# 배치: .github/workflows/deploy-backend.yml

name: Deploy Backend (Reusable)

on:
  workflow_call:
    inputs:
      project:
        description: '프로젝트명 (user-api, admin-api 등)'
        required: true
        type: string
      gradle-module:
        description: 'Gradle 모듈 경로'
        required: true
        type: string
    secrets:
      SERVER_HOST:
        required: true
      SERVER_USER:
        required: true
      SSH_PRIVATE_KEY:
        required: true

permissions:
  contents: read
  packages: write    # GHCR push 권한

env:
  IMAGE: ghcr.io/${{ github.repository }}/${{ inputs.project }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 25

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build bootJar
        run: ./gradlew ${{ inputs.gradle-module }}:bootJar

      - name: Prepare Docker context
        run: |
          mkdir -p docker-context
          cp apps/${{ inputs.project }}/build/libs/*.jar docker-context/app.jar
          cp infra/docker/backend.Dockerfile docker-context/Dockerfile

      - name: Set image tag
        id: meta
        run: echo "tag=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push
        uses: docker/build-push-action@v6
        with:
          context: docker-context
          push: true
          tags: |
            ${{ env.IMAGE }}:${{ steps.meta.outputs.tag }}
            ${{ env.IMAGE }}:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: /opt/deploy/deploy.sh ${{ inputs.project }} ${{ needs.build-and-push.outputs.image-tag }}
